{"version":3,"sources":["../src/index.ts"],"sourcesContent":["/**\r\n * Setto External SDK - Web (TypeScript/JavaScript)\r\n *\r\n * 고객사 웹에서 Setto 결제를 연동하기 위한 SDK\r\n * iframe 기반으로 wallet.settopay.com 결제 페이지를 열고 postMessage로 결과를 수신\r\n */\r\n\r\n// ============================================\r\n// Types\r\n// ============================================\r\n\r\nexport type Environment = 'dev' | 'prod';\r\n\r\nexport interface InitConfig {\r\n  environment: Environment;\r\n  debug?: boolean;\r\n}\r\n\r\nexport interface PaymentParams {\r\n  merchantId: string;\r\n  amount: string;\r\n  idpToken?: string; // IdP 토큰 (선택, 있으면 자동로그인)\r\n}\r\n\r\nexport interface InfoParams {\r\n  merchantId: string;\r\n  paymentId: string;\r\n}\r\n\r\nexport interface PaymentResult {\r\n  status: 'success' | 'failed' | 'cancelled';\r\n  paymentId?: string;\r\n  txHash?: string;\r\n  error?: string;\r\n}\r\n\r\nexport interface PaymentInfo {\r\n  paymentId: string;\r\n  status: 'pending' | 'submitted' | 'included' | 'failed' | 'cancelled';\r\n  amount: string;\r\n  currency: string;\r\n  txHash?: string;\r\n  createdAt: number;\r\n  completedAt?: number;\r\n}\r\n\r\n// ============================================\r\n// Constants\r\n// ============================================\r\n\r\nconst ENVIRONMENTS = {\r\n  dev: 'https://dev-wallet.settopay.com',\r\n  prod: 'https://wallet.settopay.com',\r\n} as const;\r\n\r\nconst MESSAGE_TYPES = {\r\n  SETTO_PAYMENT_SUCCESS: 'SETTO_PAYMENT_SUCCESS',\r\n  SETTO_PAYMENT_FAILED: 'SETTO_PAYMENT_FAILED',\r\n  SETTO_PAYMENT_CANCELLED: 'SETTO_PAYMENT_CANCELLED',\r\n} as const;\r\n\r\n// ============================================\r\n// SDK State\r\n// ============================================\r\n\r\nlet config: InitConfig | null = null;\r\n\r\nfunction getConfig(): InitConfig {\r\n  if (!config) {\r\n    throw new Error('SettoSDK not initialized. Call SettoSDK.initialize() first.');\r\n  }\r\n  return config;\r\n}\r\n\r\nfunction debugLog(...args: unknown[]): void {\r\n  if (config?.debug) {\r\n    console.log('[SettoSDK]', ...args);\r\n  }\r\n}\r\n\r\n// ============================================\r\n// SDK Implementation\r\n// ============================================\r\n\r\nexport const SettoSDK = {\r\n  /**\r\n   * SDK 초기화\r\n   *\r\n   * @param initConfig.environment - 환경 (dev | prod)\r\n   * @param initConfig.debug - 디버그 로그 (선택)\r\n   */\r\n  initialize(initConfig: InitConfig): void {\r\n    if (config) {\r\n      console.warn('[SettoSDK] Already initialized');\r\n      return;\r\n    }\r\n    config = initConfig;\r\n    debugLog('Initialized:', config);\r\n  },\r\n\r\n  /**\r\n   * 결제 요청\r\n   *\r\n   * 항상 PaymentToken을 발급받아 Fragment로 전달합니다.\r\n   * - IdP Token 없음: Setto 로그인 필요\r\n   * - IdP Token 있음: 자동로그인\r\n   */\r\n  async openPayment(params: PaymentParams): Promise<PaymentResult> {\r\n    const cfg = getConfig();\r\n    const baseUrl = ENVIRONMENTS[cfg.environment];\r\n\r\n    // 항상 PaymentToken 발급 (idpToken 유무와 상관없이)\r\n    debugLog('Requesting PaymentToken...');\r\n    try {\r\n      const body: Record<string, string> = {\r\n        merchant_id: params.merchantId,\r\n        amount: params.amount,\r\n      };\r\n      if (params.idpToken) {\r\n        body.idp_token = params.idpToken;\r\n      }\r\n\r\n      const response = await fetch(`${baseUrl}/api/external/payment/token`, {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(body),\r\n      });\r\n\r\n      const data = await response.json();\r\n      if (data.payment_error || data.system_error) {\r\n        debugLog('PaymentToken error:', data);\r\n        return { status: 'failed', error: data.payment_error || data.system_error };\r\n      }\r\n\r\n      if (!data.payment_token) {\r\n        debugLog('PaymentToken not received');\r\n        return { status: 'failed', error: 'Payment token not received' };\r\n      }\r\n\r\n      // Fragment로 전달 (보안: 서버 로그에 남지 않음)\r\n      const url = `${baseUrl}/pay/wallet#pt=${encodeURIComponent(data.payment_token)}`;\r\n      debugLog('Opening payment page');\r\n\r\n      return openIframeAndWait(url, cfg);\r\n    } catch (error) {\r\n      debugLog('PaymentToken request error:', error);\r\n      return { status: 'failed', error: 'Network error' };\r\n    }\r\n  },\r\n\r\n  /**\r\n   * 결제 상태 조회\r\n   */\r\n  async getPaymentInfo(params: InfoParams): Promise<PaymentInfo> {\r\n    const cfg = getConfig();\r\n    const baseUrl = ENVIRONMENTS[cfg.environment];\r\n    const response = await fetch(\r\n      `${baseUrl}/api/external/payment/${params.paymentId}`,\r\n      {\r\n        headers: {\r\n          'X-Merchant-ID': params.merchantId,\r\n        },\r\n      }\r\n    );\r\n    if (!response.ok) {\r\n      throw new Error(`Failed to get payment info: ${response.status}`);\r\n    }\r\n    return response.json();\r\n  },\r\n\r\n  /**\r\n   * 초기화 여부 확인\r\n   */\r\n  isInitialized(): boolean {\r\n    return config !== null;\r\n  },\r\n\r\n  /**\r\n   * SDK 리셋 (테스트용)\r\n   */\r\n  reset(): void {\r\n    config = null;\r\n  },\r\n};\r\n\r\n// ============================================\r\n// Internal Functions\r\n// ============================================\r\n\r\nfunction openIframeAndWait(url: string, cfg: InitConfig): Promise<PaymentResult> {\r\n  return new Promise((resolve) => {\r\n    // Overlay 생성 (전체 화면, 투명)\r\n    const overlay = document.createElement('div');\r\n    overlay.id = 'setto-overlay';\r\n    overlay.style.cssText = `\r\n      position: fixed;\r\n      top: 0;\r\n      left: 0;\r\n      width: 100%;\r\n      height: 100%;\r\n      background: transparent;\r\n      z-index: 99999;\r\n      pointer-events: none;\r\n    `;\r\n\r\n    // iframe 생성 (전체 화면 - 내부에서 바닥 모달 스타일 처리)\r\n    const iframe = document.createElement('iframe');\r\n    iframe.id = 'setto-iframe';\r\n    iframe.src = url;\r\n    iframe.allow = 'clipboard-write';\r\n    iframe.style.cssText = `\r\n      position: absolute;\r\n      top: 0;\r\n      left: 0;\r\n      width: 100%;\r\n      height: 100%;\r\n      border: none;\r\n      background: transparent;\r\n      pointer-events: auto;\r\n    `;\r\n\r\n    overlay.appendChild(iframe);\r\n    document.body.appendChild(overlay);\r\n\r\n    // Cleanup 함수\r\n    const cleanup = (): void => {\r\n      window.removeEventListener('message', messageHandler);\r\n      overlay.remove();\r\n    };\r\n\r\n    // ESC 키로 취소\r\n    const escHandler = (e: KeyboardEvent): void => {\r\n      if (e.key === 'Escape') {\r\n        debugLog('Payment cancelled by user (ESC key)');\r\n        cleanup();\r\n        window.removeEventListener('keydown', escHandler);\r\n        resolve({ status: 'cancelled' });\r\n      }\r\n    };\r\n    window.addEventListener('keydown', escHandler);\r\n\r\n    // postMessage 핸들러\r\n    const messageHandler = (event: MessageEvent): void => {\r\n      const baseUrl = ENVIRONMENTS[cfg.environment];\r\n      if (event.origin !== baseUrl) return;\r\n\r\n      const { type, data } = event.data;\r\n      debugLog('Received message:', type, data);\r\n\r\n      if (type === MESSAGE_TYPES.SETTO_PAYMENT_SUCCESS) {\r\n        cleanup();\r\n        window.removeEventListener('keydown', escHandler);\r\n        resolve({\r\n          status: 'success',\r\n          paymentId: data.paymentId,\r\n          txHash: data.txHash,\r\n        });\r\n      } else if (type === MESSAGE_TYPES.SETTO_PAYMENT_FAILED) {\r\n        cleanup();\r\n        window.removeEventListener('keydown', escHandler);\r\n        resolve({\r\n          status: 'failed',\r\n          error: data.error,\r\n        });\r\n      } else if (type === MESSAGE_TYPES.SETTO_PAYMENT_CANCELLED) {\r\n        cleanup();\r\n        window.removeEventListener('keydown', escHandler);\r\n        resolve({ status: 'cancelled' });\r\n      }\r\n    };\r\n\r\n    window.addEventListener('message', messageHandler);\r\n  });\r\n}\r\n\r\nexport default SettoSDK;\r\n"],"mappings":"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","names":["index_exports","__export","SettoSDK","index_default","__toCommonJS","ENVIRONMENTS","MESSAGE_TYPES","config","getConfig","debugLog","args","initConfig","params","cfg","baseUrl","body","data","url","openIframeAndWait","error","response","resolve","overlay","iframe","cleanup","messageHandler","escHandler","e","event","type"]}