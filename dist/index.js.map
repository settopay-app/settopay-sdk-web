{"version":3,"sources":["../src/index.ts"],"sourcesContent":["/**\r\n * Setto External SDK - Web (TypeScript/JavaScript)\r\n *\r\n * 고객사 웹에서 Setto 결제를 연동하기 위한 SDK\r\n * iframe 기반으로 wallet.settopay.com 결제 페이지를 열고 postMessage로 결과를 수신\r\n */\r\n\r\n// ============================================\r\n// Types\r\n// ============================================\r\n\r\nexport type Environment = 'dev' | 'prod';\r\n\r\nexport interface InitConfig {\r\n  merchantId: string;\r\n  environment: Environment;\r\n  idpToken?: string; // IdP 토큰 (있으면 자동로그인)\r\n  debug?: boolean;\r\n}\r\n\r\nexport interface PaymentParams {\r\n  amount: string;\r\n  orderId?: string;\r\n}\r\n\r\nexport interface InfoParams {\r\n  paymentId: string;\r\n}\r\n\r\nexport interface PaymentResult {\r\n  status: 'success' | 'failed' | 'cancelled';\r\n  paymentId?: string;\r\n  txHash?: string;\r\n  error?: string;\r\n}\r\n\r\nexport interface PaymentInfo {\r\n  paymentId: string;\r\n  status: 'pending' | 'submitted' | 'included' | 'failed' | 'cancelled';\r\n  amount: string;\r\n  currency: string;\r\n  txHash?: string;\r\n  createdAt: number;\r\n  completedAt?: number;\r\n}\r\n\r\n// ============================================\r\n// Constants\r\n// ============================================\r\n\r\nconst ENVIRONMENTS = {\r\n  dev: 'https://dev-wallet.settopay.com',\r\n  prod: 'https://wallet.settopay.com',\r\n} as const;\r\n\r\nconst MESSAGE_TYPES = {\r\n  SETTO_PAYMENT_SUCCESS: 'SETTO_PAYMENT_SUCCESS',\r\n  SETTO_PAYMENT_FAILED: 'SETTO_PAYMENT_FAILED',\r\n  SETTO_PAYMENT_CANCELLED: 'SETTO_PAYMENT_CANCELLED',\r\n} as const;\r\n\r\n// ============================================\r\n// SDK State\r\n// ============================================\r\n\r\nlet config: InitConfig | null = null;\r\n\r\nfunction getConfig(): InitConfig {\r\n  if (!config) {\r\n    throw new Error('SettoSDK not initialized. Call SettoSDK.initialize() first.');\r\n  }\r\n  return config;\r\n}\r\n\r\nfunction debugLog(...args: unknown[]): void {\r\n  if (config?.debug) {\r\n    console.log('[SettoSDK]', ...args);\r\n  }\r\n}\r\n\r\n// ============================================\r\n// SDK Implementation\r\n// ============================================\r\n\r\nexport const SettoSDK = {\r\n  /**\r\n   * SDK 초기화\r\n   *\r\n   * @param initConfig.merchantId - 고객사 ID (필수)\r\n   * @param initConfig.environment - 환경 (dev | prod)\r\n   * @param initConfig.idpToken - IdP 토큰 (선택, 있으면 자동로그인)\r\n   * @param initConfig.debug - 디버그 로그 (선택)\r\n   */\r\n  initialize(initConfig: InitConfig): void {\r\n    if (config) {\r\n      console.warn('[SettoSDK] Already initialized');\r\n      return;\r\n    }\r\n    config = initConfig;\r\n    debugLog('Initialized:', { ...config, idpToken: config.idpToken ? '[REDACTED]' : undefined });\r\n  },\r\n\r\n  /**\r\n   * 결제 요청\r\n   *\r\n   * IdP Token 유무에 따라 자동로그인 여부가 결정됩니다.\r\n   * - IdP Token 없음: Setto 로그인 필요\r\n   * - IdP Token 있음: PaymentToken 발급 후 자동로그인\r\n   */\r\n  async openPayment(params: PaymentParams): Promise<PaymentResult> {\r\n    const cfg = getConfig();\r\n    const baseUrl = ENVIRONMENTS[cfg.environment];\r\n\r\n    let url: string;\r\n\r\n    if (cfg.idpToken) {\r\n      // IdP Token 있음 → PaymentToken 발급 → Fragment로 전달\r\n      debugLog('Requesting PaymentToken...');\r\n      try {\r\n        const response = await fetch(`${baseUrl}/api/external/payment/token`, {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({\r\n            merchant_id: cfg.merchantId,\r\n            amount: params.amount,\r\n            order_id: params.orderId,\r\n            idp_token: cfg.idpToken,\r\n          }),\r\n        });\r\n\r\n        const data = await response.json();\r\n        if (data.payment_error || data.system_error) {\r\n          debugLog('PaymentToken error:', data);\r\n          return { status: 'failed', error: data.payment_error || data.system_error };\r\n        }\r\n\r\n        if (!data.payment_token) {\r\n          debugLog('PaymentToken not received');\r\n          return { status: 'failed', error: 'Payment token not received' };\r\n        }\r\n\r\n        // Fragment로 전달 (보안: 서버 로그에 남지 않음)\r\n        url = `${baseUrl}/pay/wallet#pt=${encodeURIComponent(data.payment_token)}`;\r\n        debugLog('Opening payment with auto-login');\r\n      } catch (error) {\r\n        debugLog('PaymentToken request error:', error);\r\n        return { status: 'failed', error: 'Network error' };\r\n      }\r\n    } else {\r\n      // IdP Token 없음 → Query param으로 직접 전달\r\n      const paymentUrl = new URL(`${baseUrl}/pay/wallet`);\r\n      paymentUrl.searchParams.set('merchant_id', cfg.merchantId);\r\n      paymentUrl.searchParams.set('amount', params.amount);\r\n      if (params.orderId) {\r\n        paymentUrl.searchParams.set('order_id', params.orderId);\r\n      }\r\n      url = paymentUrl.toString();\r\n      debugLog('Opening payment with Setto login');\r\n    }\r\n\r\n    return openIframeAndWait(url, cfg);\r\n  },\r\n\r\n  /**\r\n   * 결제 상태 조회\r\n   */\r\n  async getPaymentInfo(params: InfoParams): Promise<PaymentInfo> {\r\n    const cfg = getConfig();\r\n    const baseUrl = ENVIRONMENTS[cfg.environment];\r\n    const response = await fetch(\r\n      `${baseUrl}/api/external/payment/${params.paymentId}`,\r\n      {\r\n        headers: {\r\n          'X-Merchant-ID': cfg.merchantId,\r\n        },\r\n      }\r\n    );\r\n    if (!response.ok) {\r\n      throw new Error(`Failed to get payment info: ${response.status}`);\r\n    }\r\n    return response.json();\r\n  },\r\n\r\n  /**\r\n   * 초기화 여부 확인\r\n   */\r\n  isInitialized(): boolean {\r\n    return config !== null;\r\n  },\r\n\r\n  /**\r\n   * SDK 리셋 (테스트용)\r\n   */\r\n  reset(): void {\r\n    config = null;\r\n  },\r\n};\r\n\r\n// ============================================\r\n// Internal Functions\r\n// ============================================\r\n\r\nfunction openIframeAndWait(url: string, cfg: InitConfig): Promise<PaymentResult> {\r\n  return new Promise((resolve) => {\r\n    // Overlay 생성\r\n    const overlay = document.createElement('div');\r\n    overlay.id = 'setto-overlay';\r\n    overlay.style.cssText = `\r\n      position: fixed;\r\n      top: 0;\r\n      left: 0;\r\n      width: 100%;\r\n      height: 100%;\r\n      background: rgba(0, 0, 0, 0.5);\r\n      z-index: 99999;\r\n      display: flex;\r\n      align-items: center;\r\n      justify-content: center;\r\n    `;\r\n\r\n    // iframe 생성\r\n    const iframe = document.createElement('iframe');\r\n    iframe.id = 'setto-iframe';\r\n    iframe.src = url;\r\n    iframe.style.cssText = `\r\n      width: 420px;\r\n      height: 680px;\r\n      max-width: 95vw;\r\n      max-height: 90vh;\r\n      border: none;\r\n      border-radius: 16px;\r\n      background: white;\r\n    `;\r\n\r\n    overlay.appendChild(iframe);\r\n    document.body.appendChild(overlay);\r\n\r\n    // Cleanup 함수\r\n    const cleanup = (): void => {\r\n      window.removeEventListener('message', messageHandler);\r\n      overlay.remove();\r\n    };\r\n\r\n    // Overlay 클릭 시 취소\r\n    overlay.addEventListener('click', (e) => {\r\n      if (e.target === overlay) {\r\n        debugLog('Payment cancelled by user (overlay click)');\r\n        cleanup();\r\n        resolve({ status: 'cancelled' });\r\n      }\r\n    });\r\n\r\n    // ESC 키로 취소\r\n    const escHandler = (e: KeyboardEvent): void => {\r\n      if (e.key === 'Escape') {\r\n        debugLog('Payment cancelled by user (ESC key)');\r\n        cleanup();\r\n        window.removeEventListener('keydown', escHandler);\r\n        resolve({ status: 'cancelled' });\r\n      }\r\n    };\r\n    window.addEventListener('keydown', escHandler);\r\n\r\n    // postMessage 핸들러\r\n    const messageHandler = (event: MessageEvent): void => {\r\n      const baseUrl = ENVIRONMENTS[cfg.environment];\r\n      if (event.origin !== baseUrl) return;\r\n\r\n      const { type, data } = event.data;\r\n      debugLog('Received message:', type, data);\r\n\r\n      if (type === MESSAGE_TYPES.SETTO_PAYMENT_SUCCESS) {\r\n        cleanup();\r\n        window.removeEventListener('keydown', escHandler);\r\n        resolve({\r\n          status: 'success',\r\n          paymentId: data.paymentId,\r\n          txHash: data.txHash,\r\n        });\r\n      } else if (type === MESSAGE_TYPES.SETTO_PAYMENT_FAILED) {\r\n        cleanup();\r\n        window.removeEventListener('keydown', escHandler);\r\n        resolve({\r\n          status: 'failed',\r\n          error: data.error,\r\n        });\r\n      } else if (type === MESSAGE_TYPES.SETTO_PAYMENT_CANCELLED) {\r\n        cleanup();\r\n        window.removeEventListener('keydown', escHandler);\r\n        resolve({ status: 'cancelled' });\r\n      }\r\n    };\r\n\r\n    window.addEventListener('message', messageHandler);\r\n  });\r\n}\r\n\r\nexport default SettoSDK;\r\n"],"mappings":"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","names":["index_exports","__export","SettoSDK","index_default","__toCommonJS","ENVIRONMENTS","MESSAGE_TYPES","config","getConfig","debugLog","args","initConfig","params","cfg","baseUrl","url","data","error","paymentUrl","openIframeAndWait","response","resolve","overlay","iframe","cleanup","messageHandler","e","escHandler","event","type"]}